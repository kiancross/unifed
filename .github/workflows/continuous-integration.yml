#
# CS3099 Group A3
#

name: Continuous Integration

on:
  workflow_dispatch:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  run:
    name: Run
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v2.3.4
        with:
          fetch-depth: 2

      - uses: actions/setup-node@v2.1.5
        with:
          node-version: 12

      - id: yarn-paths
        run: |
          echo "::set-output name=cache::$(yarn config get cacheFolder)"
          echo "::set-output name=install::$(yarn config get installStatePath)"
          echo "::set-output name=build::$(yarn config get bstatePath)"
          echo "::set-output name=unplugged::$(yarn config get pnpUnpluggedFolder)"

      - uses: actions/cache@v2.1.5
        id: cache
        with:
          path: |
            ${{ steps.yarn-paths.outputs.cache }}
            ${{ steps.yarn-paths.outputs.install }}
            ${{ steps.yarn-paths.outputs.build }}
            ${{ steps.yarn-paths.outputs.unplugged }}
            .pnp.cjs
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - uses: actions/cache@v2.1.5
        id: mongo-cache
        with:
          path: ~/.cache/mongodb-binaries
          key: ${{ runner.os }}-mongodb

      - run: npm install -g yarn

      - name: Install Dependencies ğŸ—ï¸
        if: steps.cache.outputs.cache-hit != 'true'
        run: yarn install

      - name: Build â›ï¸
        run: yarn build

      - name: Generate GraphQL Schema âš™ï¸
        if: github.ref != 'refs/heads/master'
        run: |
          yarn workspace @unifed/backend-internal-server ts-node scripts/generate-schema.ts
          cp packages/backend-internal-server/.schema.graphql packages/frontend/

      - name: Code Style ğŸ‘ 
        if: github.ref != 'refs/heads/master'
        run: yarn lint

      - name: Test ğŸ“
        run: yarn test

      - name: Upload Coverage Report (backend-core) 1ï¸âƒ£ ğŸ“Š
        uses: codecov/codecov-action@v1.5.0
        if: github.actor != 'dependabot[bot]'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: backend-core
          directory: packages/backend-core
          fail_ci_if_error: true

      - name: Upload Coverage Report (backend-federation-client) 2ï¸âƒ£ ğŸ“Š
        uses: codecov/codecov-action@v1.5.0
        if: github.actor != 'dependabot[bot]'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: backend-federation-client
          directory: packages/backend-federation-client
          fail_ci_if_error: true

      - name: Upload Coverage Report (backend-federation-server) 3ï¸âƒ£ ğŸ“Š
        uses: codecov/codecov-action@v1.5.0
        if: github.actor != 'dependabot[bot]'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: backend-federation-server
          directory: packages/backend-federation-server
          fail_ci_if_error: true

      - name: Upload Coverage Report (backend-internal-server) 4ï¸âƒ£ ğŸ“Š
        uses: codecov/codecov-action@v1.5.0
        if: github.actor != 'dependabot[bot]'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: backend-internal-server
          directory: packages/backend-internal-server
          fail_ci_if_error: true

      - name: Upload Coverage Report (backend-ml) 5ï¸âƒ£ ğŸ“Š
        uses: codecov/codecov-action@v1.5.0
        if: github.actor != 'dependabot[bot]'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: backend-ml
          directory: packages/backend-ml
          fail_ci_if_error: true
      
      - name: Upload Coverage Report (frontend) 6ï¸âƒ£ ğŸ“Š
        uses: codecov/codecov-action@v1.5.0
        if: github.actor != 'dependabot[bot]'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: frontend
          directory: packages/frontend
          fail_ci_if_error: true

      - name: Upload Coverage Report (shared) 7ï¸âƒ£ ğŸ“Š
        uses: codecov/codecov-action@v1.5.0
        if: github.actor != 'dependabot[bot]'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: shared
          directory: packages/shared
          fail_ci_if_error: true
      
      - name: Generate Developer Documentation ğŸ”§
        run: yarn dev-docs

      - name: Save Documentation ğŸ’¾
        if: github.ref == 'refs/heads/master'
        uses: actions/upload-artifact@v2
        with:
          name: documentation
          path: docs
      
      - name: Deploy Documentation ğŸš€
        uses: JamesIves/github-pages-deploy-action@4.1.1
        if: github.ref == 'refs/heads/master'
        with:
          branch: gh-pages
          folder: docs
