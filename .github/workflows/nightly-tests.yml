#
# CS3099 Group A3
#

name: Nightly Tests

on:
  workflow_dispatch:
  schedule:
    # Everyday at 6am
    - cron:  "0 6 */1 * *"

jobs:
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v2

      - uses: actions/setup-node@v2
        with:
          node-version: 12

      - run: echo "::set-output name=dir::$(yarn config get cacheFolder)"
        id: yarn-cache-dir-path

      - uses: actions/cache@v2
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}-
            ${{ runner.os }}-yarn-
      
      - run: npm install -g yarn

      - name: Install Dependencies 🏗️
        run: yarn install
      
      - name: Build Shared ⛏️
        run: yarn workspaces foreach -vtp --include '@unifed/{shared,backend-{core,federation-client}}' run build

      - name: Test 📝
        run: yarn workspaces foreach -vp run test
      
      - name: Upload Coverage Report (backend-core) 1️⃣ 📊
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: backend-core
          directory: packages/backend-core
          fail_ci_if_error: true
          verbose: true

      - name: Upload Coverage Report (backend-federation-client) 2️⃣ 📊
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: backend-federation-client
          directory: packages/backend-federation-client
          fail_ci_if_error: true
          verbose: true

#      - name: Upload Coverage Report (backend-federation-server) 3️⃣ 📊
#        uses: codecov/codecov-action@v1
#        with:
#          token: ${{ secrets.CODECOV_TOKEN }}
#          flags: backend-federation-server
#          directory: packages/backend-federation-server
#          fail_ci_if_error: true
#          verbose: true

      - name: Upload Coverage Report (backend-internal-server) 4️⃣ 📊
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: backend-internal-server
          directory: packages/backend-internal-server
          fail_ci_if_error: true
          verbose: true

      - name: Upload Coverage Report (frontend) 5️⃣ 📊
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: frontend
          directory: packages/frontend
          fail_ci_if_error: true
          verbose: true

      - name: Upload Coverage Report (shared) 6️⃣ 📊
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: shared
          directory: packages/shared
          fail_ci_if_error: true
          verbose: true
